<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대건고 열품타</title>
    <!-- (추가) Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='orange'%3E%3Cpath d='M12 2.69c-3.14 0-6 2.68-6 6 0 2.24 1.25 4.2 3 5.18.3.15.3.5 0 .65C6.25 15.2 3 17.15 3 20c0 1.66 1.34 3 3 3h12c1.66 0 3-1.34 3-3 0-2.85-3.25-4.8-6-5.48-.3-.15-.3-.5 0-.65 1.75-.98 3-2.94 3-5.18 0-3.32-2.86-6-6-6z'%3E%3C/path%3E%3C/svg%3E" type="image/svg+xml">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard */
        }
        /* 스크롤바 숨기기 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        .timeline-grid {
            /* (수정) 그리드 속성 대신 높이와 위치 기준만 유지 */
            position: relative;
            height: 864px; /* 1440px * 0.6 = 864px */
        }
        .timeline-hour-label {
            height: 36px; /* 60px * 0.6 = 36px */
        }
        /* (수정) 분 단위 렌더링을 위해 이 클래스는 더 이상 사용되지 않음 */
        /* .timeline-data { ... } */

        /* 현재 시간 표시선 */
        #current-time-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: red;
            z-index: 10;
            left: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden h-screen flex flex-col">

    <!-- 1. 로그인 화면 -->
    <div id="login-screen" class="flex flex-col items-center justify-center h-full text-center p-4">
        <h1 class="text-4xl font-bold mb-4">대건고 열품타</h1>
        <p class="text-lg text-gray-400 mb-8">대건고등학교 학생들을 위한 열정 품은 타이머</p>
        <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 shadow-lg">
            PESS 계정으로 로그인
        </button>
        <p id="auth-status" class="text-gray-500 mt-4 text-sm"></p>
    </div>

    <!-- 2. 홈 화면 (로그인 후) -->
    <div id="home-screen" class="hidden flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- 메인 컨텐츠 (타이머 + 타임라인) -->
        <div class="flex-1 flex flex-col justify-between items-center p-4 md:p-8 overflow-hidden">
            
            <!-- 오늘 총 공부 시간 -->
            <div class="w-full flex justify-between items-center mb-4">
                <div class="text-left">
                    <span class="text-gray-400 text-sm" id="user-display-name"></span>
                </div>
                <div class="text-right">
                    <span class="text-gray-400 text-sm">오늘 총 공부 시간</span>
                    <h2 id="total-today-study-time" class="text-2xl font-bold">00:00:00</h2>
                </div>
            </div>

            <!-- 타임라인 스크롤 컨테이너 -->
            <div id="timeline-scroll-container" class="w-full flex-1 bg-gray-800 rounded-lg shadow-inner overflow-hidden flex mb-4 relative min-h-0">
                
                <!-- 시간 레이블 컨테이너 -->
                <div id="timeline-hour-labels" class="w-12 text-xs text-gray-400 text-right pr-2 bg-gray-800 z-10 overflow-y-hidden no-scrollbar">
                    <div style="height: 864px;"> <!-- 864px 높이의 내부 컨테이너 -->
                        <!-- JS로 동적 생성 -->
                    </div>
                </div>

                <!-- 타임라인 그리드 (스크롤됨) -->
                <div id="timeline-container" class="flex-1 relative overflow-y-auto no-scrollbar">
                    
                    <!-- 실제 864px 높이를 가진 내부 그리드 컨테이너 -->
                    <div id="timeline-grid-inner" class="timeline-grid">
                        <!-- JS로 동적 생성 -->
                        <div id="current-time-line"></div>
                    </div>

                </div>
            </div>

            <!-- 하단 타이머 시작 버튼 -->
            <button id="start-study-btn" class="w-full md:w-1/2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300 shadow-lg flex-shrink-0" disabled>
                과목을 선택해주세요.
            </button>
        </div>

        <!-- 오른쪽 사이드바 (과목 리스트) -->
        <div class="w-full md:w-64 bg-gray-800 p-4 overflow-y-auto no-scrollbar flex-shrink-0 md:h-screen">
            <h3 class="text-lg font-semibold mb-4 mt-4">과목 리스트</h3>
            <div id="subject-list" class="space-y-1"> 
                <!-- 과목 리스트 원복 (p-2, text-sm) -->
            </div>
        </div>

    </div>

    <!-- 3. 공부 시작 화면 -->
    <div id="study-screen" class="hidden flex-1 flex flex-col p-4 md:p-8 overflow-hidden">
        <!-- 상단 내 정보 및 중지 버튼 (총 시간 추가) -->
        <div class="flex justify-between items-start mb-6"> 
            <div class="text-left">
                <span id="current-subject-label" class="text-xl font-semibold"></span>
                <h1 id="my-study-timer" class="text-5xl md:text-7xl font-bold tracking-tighter">00:00:00</h1>
            </div>
            
            <!-- 중지 버튼 + 오늘 총 시간 -->
            <div class="text-right flex-shrink-0">
                <button id="stop-study-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 shadow-lg mb-2">
                    중지
                </button>
                <div class="text-right">
                    <span class="text-gray-400 text-sm">오늘 총 공부 시간</span>
                    <h2 id="total-today-study-time-in-study" class="text-xl font-bold">00:00:00</h2>
                </div>
            </div>
        </div>

        <!-- 친구들 공부 현황 -->
        <div class="flex-1 overflow-y-auto no-scrollbar">
            <h2 class="text-xl font-semibold mb-4 text-gray-400">실시간 공부 현황</h2>
            <div id="friends-study-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- JS로 동적 생성 -->
            </div>
        </div>
    </div>

    <!-- 모달: 휴식 사유 선택 -->
    <div id="rest-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 shadow-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-semibold mb-2">휴식 시간</h2>
            <p id="rest-time-display" class="text-3xl font-bold mb-6"></p>
            <p class="text-gray-400 mb-4">휴식 사유를 선택해주세요.</p>
            <div class="space-y-3">
                <button class="rest-reason-btn w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg" data-reason="#휴식">#휴식</button>
                <button class="rest-reason-btn w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg" data-reason="#화장실">#화장실</button>
                <button class="rest-reason-btn w-full bg-yellow-600 hover:bg-yellow-700 py-2 rounded-lg" data-reason="#학교수업">#학교수업</button>
                <button class="rest-reason-btn w-full bg-gray-600 hover:bg-gray-700 py-2 rounded-lg" data-reason="#기타">#기타</button>
            </div>
        </div>
    </div>

    <!-- 모달: 타임라인 통계 -->
    <div id="timeline-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 shadow-xl w-full max-w-lg h-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <input type="date" id="timeline-date-picker" class="bg-gray-700 text-white rounded-md p-2">
                <button id="close-timeline-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <p class="text-center text-lg mb-2"><span id="modal-total-time"></span> 공부</p>
            <!-- (추가) 어제와 비교 메시지 -->
            <p id="modal-comparison-text" class="text-center text-sm mb-4 hidden"></p>
            
            <div class="flex-1 min-h-0">
                <canvas id="study-pie-chart"></canvas>
            </div>
            <div id="modal-timeline-container" class="mt-4 h-48 overflow-y-auto no-scrollbar border-t border-gray-700 pt-4">
                <!-- 일간 타임라인 상세 내용 -->
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Firebase 앱 SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Firebase Auth SDK
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged, 
            setPersistence, 
            browserLocalPersistence, 
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Firebase Firestore SDK
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            onSnapshot, 
            query, 
            where, 
            addDoc, 
            Timestamp,
            getDocs,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -----------------------------------------------------------------
        // 1. Firebase 설정
        // -----------------------------------------------------------------
        
        const firebaseConfig = {
            apiKey: "AIzaSyCEB6l20bQ1wk91If9ixCFKwRyscBgQK78",
            authDomain: "yeolpumta-dg.firebaseapp.com",
            projectId: "yeolpumta-dg",
            storageBucket: "yeolpumta-dg.firebasestorage.app",
            messagingSenderId: "106655381615",
            appId: "1:106655381615:web:23179c40c091ab17cef59a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('Debug'); 

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'yeolpumta-dg';

        // -----------------------------------------------------------------
        // 2. 전역 변수 및 상태 관리
        // -----------------------------------------------------------------
        let currentUser = null; 
        let userId = null; 
        let currentSubject = null; 
        let studyStartTime = null; 
        let studyTimerInterval = null; 
        let lastStudyEndTime = null; 
        let currentStudySessionId = null; 
        
        let friendsListener = null;
        let todayTimelineListener = null; 
        let totalTodayStudyListener = null; 
        
        let currentTotalStudySeconds = 0; // 총 공부 시간 (초)
        
        let liveStatusUpdateInterval = null; 
        
        let friendsTimers = {};

        // 기본 과목
        const defaultSubjects = {
            "국어": "#EF4444", // red-500
            "수학": "#EAB308", // yellow-500
            "영어": "#8B5CF6", // violet-500
            "사회": "#22C55E", // green-500
            "과학": "#3B82F6", // blue-500
            "역사": "#78350F", // A (진한 갈색 - amber-900)
        };
        const subjectColors = { ...defaultSubjects };
        
        const TIMELINE_TOTAL_HEIGHT = 864; // 1440 * 0.6

        // DOM 요소
        const loginScreen = document.getElementById('login-screen');
        const homeScreen = document.getElementById('home-screen');
        const studyScreen = document.getElementById('study-screen');
        const loginBtn = document.getElementById('login-btn');
        const authStatus = document.getElementById('auth-status');
        const userDisplayName = document.getElementById('user-display-name');
        const totalTodayStudyTimeEl = document.getElementById('total-today-study-time');
        
        const timelineScrollContainer = document.getElementById('timeline-scroll-container'); 
        const timelineHourLabels = document.getElementById('timeline-hour-labels'); 
        const timelineContainer = document.getElementById('timeline-container'); 
        const timelineGridInner = document.getElementById('timeline-grid-inner'); 
        
        const startStudyBtn = document.getElementById('start-study-btn');
        const subjectListEl = document.getElementById('subject-list');
        const currentSubjectLabel = document.getElementById('current-subject-label');
        const myStudyTimer = document.getElementById('my-study-timer');
        const stopStudyBtn = document.getElementById('stop-study-btn');
        const friendsStudyGrid = document.getElementById('friends-study-grid');
        const restModal = document.getElementById('rest-modal');
        const restTimeDisplay = document.getElementById('rest-time-display');
        
        const totalTodayStudyTimeInStudyEl = document.getElementById('total-today-study-time-in-study');

        // 통계 모달 DOM
        const timelineModal = document.getElementById('timeline-modal');
        const timelineDatePicker = document.getElementById('timeline-date-picker');
        const closeTimelineModal = document.getElementById('close-timeline-modal');
        const modalTotalTimeEl = document.getElementById('modal-total-time');
        const modalComparisonTextEl = document.getElementById('modal-comparison-text'); // (추가)
        const modalTimelineContainer = document.getElementById('modal-timeline-container');
        const pieChartCanvas = document.getElementById('study-pie-chart');
        let studyPieChart = null;

        // -----------------------------------------------------------------
        // 3. 유틸리티 함수
        // -----------------------------------------------------------------

        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds]
                .map(v => v.toString().padStart(2, '0'))
                .join(':');
        }

        function getYYYYMMDD(dateInput) {
            const date = dateInput instanceof Timestamp ? dateInput.toDate() : dateInput;
            // KST (UTC+9) 기준으로 날짜 문자열 생성
            const kstOffset = 9 * 60 * 60 * 1000;
            const kstDate = new Date(date.getTime() + kstOffset);
            return kstDate.toISOString().split('T')[0];
        }

        function getKSTTodayRange(date = new Date()) {
            const kstDateStr = new Date(date.getTime() + (9 * 60 * 60 * 1000)).toISOString().split('T')[0];
            const [year, month, day] = kstDateStr.split('-').map(Number);
            // KST 자정(00:00)은 UTC 기준 전날 15:00
            const start = new Date(Date.UTC(year, month - 1, day, -9, 0, 0)); // KST 00:00:00
            // KST 23:59:59는 UTC 기준 당일 14:59:59
            const end = new Date(Date.UTC(year, month - 1, day, 14, 59, 59, 999)); // KST 23:59:59
            return { start, end, todayString: kstDateStr };
        }
        
        /**
         * (추가) YYYY-MM-DD 형식의 날짜 문자열을 받아 그 전날의 YYYY-MM-DD를 반환
         */
        function getYesterdayDateString(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            // KST 기준으로 날짜 객체 생성 (정오쯤으로)
            const date = new Date(Date.UTC(year, month - 1, day, 3, 0, 0)); // 12:00 KST = 03:00 UTC
            // 하루(24시간) 빼기
            date.setUTCDate(date.getUTCDate() - 1); 
            // 다시 KST 기준으로 YYYY-MM-DD 반환
            const kstDateStr = new Date(date.getTime() + (9 * 60 * 60 * 1000)).toISOString().split('T')[0];
            return kstDateStr;
        }

        // -----------------------------------------------------------------
        // 4. Firebase 인증 (Authentication)
        // -----------------------------------------------------------------
        
        async function signInWithGoogle() {
            authStatus.textContent = '로그인 시도 중...';
            try {
                await setPersistence(auth, browserLocalPersistence);
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                currentUser = result.user;
                userId = currentUser.uid;
                authStatus.textContent = `${currentUser.displayName}님, 환영합니다.`;
                await initializeUserData(currentUser);
                showHomeScreen();
            } catch (error) {
                console.error("Google 로그인 실패:", error);
                authStatus.textContent = `로그인 실패: ${error.message}`;
            }
        }

        async function initializeUserData(user) {
            if (!user) return;
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                await setDoc(userRef, {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    createdAt: Timestamp.now(),
                    subjects: defaultSubjects, 
                    totalStudyTime: 0 
                });
            } else {
                const userData = userDoc.data();
                if (userData.subjects) {
                    Object.assign(subjectColors, userData.subjects);
                }
            }
        }

        function observeAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    userId = user.uid;
                    authStatus.textContent = `${currentUser.displayName}님, 자동 로그인되었습니다.`;
                    await initializeUserData(user);
                    showHomeScreen();
                } else {
                    currentUser = null;
                    userId = null;
                    showLoginScreen();
                }
            });
        }

        // -----------------------------------------------------------------
        // 5. 화면 전환
        // -----------------------------------------------------------------

        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            homeScreen.classList.add('hidden');
            studyScreen.classList.add('hidden');
            cleanupListeners();
        }

        function showHomeScreen() {
            loginScreen.classList.add('hidden');
            homeScreen.classList.remove('hidden');
            studyScreen.classList.add('hidden');
            userDisplayName.textContent = `${currentUser.displayName}님`;
            renderSubjectList();
            renderTimelineHours(); 
            updateCurrentTimeLine(); // 즉시 호출
            setupHomeListeners();
            setTimeout(scrollTimelineToCurrent, 100);
        }

        function showStudyScreen() {
            loginScreen.classList.add('hidden');
            homeScreen.classList.add('hidden');
            studyScreen.classList.remove('hidden');
            cleanupListeners();
            setupStudyListeners(); // 총 시간 리스너 포함
        }
        
        function cleanupFriendsTimers() {
            for (const uid in friendsTimers) {
                clearInterval(friendsTimers[uid]);
            }
            friendsTimers = {};
        }

        function cleanupListeners() {
            if (friendsListener) friendsListener();
            if (todayTimelineListener) todayTimelineListener();
            if (totalTodayStudyListener) totalTodayStudyListener();
            if (liveStatusUpdateInterval) clearInterval(liveStatusUpdateInterval);
            
            cleanupFriendsTimers(); 
            
            friendsListener = null;
            todayTimelineListener = null;
            totalTodayStudyListener = null;
            liveStatusUpdateInterval = null; 
        }


        // -----------------------------------------------------------------
        // 6. 홈 화면 (과목, 타임라인)
        // -----------------------------------------------------------------

        function setupHomeListeners() {
            if (todayTimelineListener || totalTodayStudyListener) return;
            
            const { start, end, todayString } = getKSTTodayRange();

            // A. 오늘 하루 총 공부 시간 (total_daily_study)
            const totalStudyRef = doc(db, "users", userId, "total_daily_study", todayString);
            totalTodayStudyListener = onSnapshot(totalStudyRef, (doc) => {
                let totalSeconds = 0;
                if (doc.exists()) {
                    totalSeconds = doc.data().totalSeconds || 0;
                }
                currentTotalStudySeconds = totalSeconds;
                
                totalTodayStudyTimeEl.textContent = formatTime(totalSeconds);
                if (totalTodayStudyTimeInStudyEl) {
                    totalTodayStudyTimeInStudyEl.textContent = formatTime(totalSeconds);
                }
            });

            // B. 오늘 하루 타임라인 (study_sessions)
            const sessionsQuery = query(
                collection(db, "study_sessions"),
                where("userId", "==", userId),
                where("startTime", ">=", start),
                where("startTime", "<=", end)
            );
            
            todayTimelineListener = onSnapshot(sessionsQuery, (snapshot) => {
                renderTodayTimeline(snapshot.docs.map(d => d.data()));
            });
        }
        
        function renderSubjectList() {
            subjectListEl.innerHTML = ''; 
            for (const [name, color] of Object.entries(subjectColors)) {
                const subjectItem = document.createElement('button');
                subjectItem.className = `w-full text-left p-2 rounded-md transition duration-200 flex items-center justify-between ${currentSubject === name ? 'ring-2 ring-white' : 'hover:bg-gray-700'}`;
                subjectItem.dataset.name = name;
                subjectItem.innerHTML = `
                    <span class="font-semibold text-sm">${name}</span>
                    <span class="w-3 h-3 rounded-full" style="background-color: ${color};"></span>
                `;
                subjectItem.addEventListener('click', () => selectSubject(name));
                subjectListEl.appendChild(subjectItem);
            }
        }
        
        function selectSubject(name) {
            currentSubject = name;
            startStudyBtn.disabled = false;
            startStudyBtn.textContent = `${name} 공부 시작하기`;
            startStudyBtn.style.backgroundColor = subjectColors[name];
            startStudyBtn.style.color = "#FFFFFF";
            renderSubjectList();
        }

        function renderTimelineHours() {
            const hourLabelContainer = document.querySelector('#timeline-hour-labels > div');
            if (!hourLabelContainer) return;
            hourLabelContainer.innerHTML = ''; 
            for (let i = 0; i < 24; i++) {
                const hourDiv = document.createElement('div');
                hourDiv.className = 'timeline-hour-label flex items-start justify-end';
                hourDiv.textContent = `${i.toString().padStart(2, '0')}:00`;
                hourLabelContainer.appendChild(hourDiv);
            }
        }
        
        /**
         * (수정) 오늘 타임라인을 분 단위로 정확하게 렌더링
         */
        function renderTodayTimeline(sessions) {
            const gridInner = document.getElementById('timeline-grid-inner');
            if (!gridInner) return;

            gridInner.innerHTML = ''; // 모두 지우기

            // 1. (수정) 5분 단위 배경선 그리기 (시각적 보조)
            const lineFragment = document.createDocumentFragment();
            for (let i = 0; i < 288; i++) {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'border-b border-gray-700 opacity-30';
                lineDiv.style.minHeight = '3px'; // 864px / 288 = 3px
                lineDiv.style.height = '3px';
                lineFragment.appendChild(lineDiv);
            }
            gridInner.appendChild(lineFragment);

            // 2. (수정) 현재 시간 선 추가
            const timeLineDiv = document.createElement('div');
            timeLineDiv.id = 'current-time-line';
            gridInner.appendChild(timeLineDiv);
            
            // 3. (수정) 세션 블록을 분 단위로 절대 위치에 렌더링
            sessions.forEach(session => {
                const start = session.startTime.toDate();
                // endTime이 없으면(공부 중이면) 현재 시간으로
                const end = session.endTime ? session.endTime.toDate() : new Date(); 
                
                const startMinute = start.getHours() * 60 + start.getMinutes();
                let endMinute = end.getHours() * 60 + end.getMinutes();
                
                // 자정을 넘어가는 경우 처리
                if (end < start || (endMinute === 0 && startMinute > 0)) {
                    endMinute = 24 * 60; // 23:59 (1440분)
                }
                
                const durationMinutes = endMinute - startMinute;
                if (durationMinutes <= 0) return;
                
                // 분 단위로 top과 height 계산
                const top = (startMinute / (24 * 60)) * TIMELINE_TOTAL_HEIGHT;
                const height = (durationMinutes / (24 * 60)) * TIMELINE_TOTAL_HEIGHT;
                
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'absolute opacity-75 rounded'; // "적당한 폭"
                sessionDiv.style.backgroundColor = session.subjectColor;
                sessionDiv.style.top = `${top}px`;
                sessionDiv.style.height = `${Math.max(1, height)}px`; // 최소 1px
                sessionDiv.style.left = '10%'; // 중앙 정렬 (양옆 10% 여백)
                sessionDiv.style.width = '80%'; // 폭 80%
                gridInner.appendChild(sessionDiv); 
            });

            // 4. 현재 시간 선 위치 업데이트
            updateCurrentTimeLine();
        }


        function updateCurrentTimeLine() {
            const line = document.getElementById('current-time-line'); 
            if (!line) return;
            
            const now = new Date();
            // (확인) 1번 요청: 분 단위 반영
            const totalMinutes = now.getHours() * 60 + now.getMinutes();
            const topPosition = (totalMinutes / (24 * 60)) * TIMELINE_TOTAL_HEIGHT; 
            line.style.top = `${topPosition}px`;
        }

        function scrollTimelineToCurrent() {
            const line = document.getElementById('current-time-line');
            if (!line) return;
            const topPosition = parseFloat(line.style.top) || 0;
            const container = document.getElementById('timeline-container'); 
            if (container) {
                const containerHeight = container.clientHeight;
                container.scrollTop = topPosition - (containerHeight / 2);
            }
        }

        // -----------------------------------------------------------------
        // 7. 공부 시작 화면 (타이머, 친구 현황)
        // -----------------------------------------------------------------

        async function startStudy() {
            if (!currentSubject) return;
            studyStartTime = new Date();
            
            if (lastStudyEndTime && (studyStartTime.getTime() - lastStudyEndTime.getTime()) < 2 * 60 * 60 * 1000) {
                const restSeconds = Math.floor((studyStartTime.getTime() - lastStudyEndTime.getTime()) / 1000);
                showRestModal(restSeconds);
                return;
            }
            logRestAndStartStudy();
        }
        
        async function logRestAndStartStudy(restReason = null) {
            if (restReason && lastStudyEndTime) {
                console.log("휴식 기록:", restReason, formatTime(Math.floor((new Date().getTime() - lastStudyEndTime.getTime()) / 1000)));
            }
            
            try {
                // 1. study_sessions에 기록
                const sessionData = {
                    userId: userId,
                    displayName: currentUser.displayName,
                    subjectName: currentSubject,
                    subjectColor: subjectColors[currentSubject],
                    startTime: Timestamp.fromDate(studyStartTime),
                    endTime: null, 
                    status: 'studying'
                };
                const docRef = await addDoc(collection(db, "study_sessions"), sessionData);
                currentStudySessionId = docRef.id;
                
                // 2. 화면 전환 및 타이머 시작
                currentSubjectLabel.textContent = currentSubject;
                showStudyScreen();
                runMyStudyTimer(); // 총 시간 타이머 시작
                
                // 3. live_status 즉시 업데이트
                await updateLiveStatus(currentTotalStudySeconds);

            } catch (error) {
                console.error("공부 시작 세션/상태 생성 실패:", error);
            }
        }
        
        function showRestModal(restSeconds) {
            restTimeDisplay.textContent = formatTime(restSeconds);
            restModal.classList.remove('hidden');
        }

        async function stopStudy() {
            if (!currentStudySessionId) return;

            const studyEndTime = new Date();
            lastStudyEndTime = studyEndTime; 
            const studyDurationSeconds = Math.floor((studyEndTime.getTime() - studyStartTime.getTime()) / 1000);

            // 1. 모든 인터벌 중지
            if (studyTimerInterval) clearInterval(studyTimerInterval);
            if (liveStatusUpdateInterval) clearInterval(liveStatusUpdateInterval);
            studyTimerInterval = null;
            liveStatusUpdateInterval = null;

            try {
                // 2. "study_sessions" 문서 업데이트
                const sessionRef = doc(db, "study_sessions", currentStudySessionId);
                await setDoc(sessionRef, {
                    endTime: Timestamp.fromDate(studyEndTime),
                    status: 'finished',
                    durationSeconds: studyDurationSeconds
                }, { merge: true });

                // 3. "total_daily_study" 업데이트
                const { todayString } = getKSTTodayRange(studyStartTime);
                const totalStudyRef = doc(db, "users", userId, "total_daily_study", todayString);
                
                const docSnap = await getDoc(totalStudyRef);
                let currentTotal = 0;
                if (docSnap.exists()) {
                    currentTotal = docSnap.data().totalSeconds || 0;
                }
                
                const finalTotalSeconds = currentTotal + studyDurationSeconds;
                await setDoc(totalStudyRef, {
                    totalSeconds: finalTotalSeconds,
                    date: todayString,
                    userId: userId
                }, { merge: true });
                
                // 4. live_status를 'offline'으로 업데이트
                const liveRef = doc(db, "live_status", userId);
                await setDoc(liveRef, {
                    status: "offline",
                    liveTotalSeconds: finalTotalSeconds, // 마지막 총 시간
                    lastUpdated: Timestamp.now()
                }, { merge: true });

            } catch (error) {
                console.error("공부 중지/상태 업데이트 실패:", error);
            }

            // 5. 홈 화면 복귀
            currentStudySessionId = null;
            studyStartTime = null;
            showHomeScreen();
        }

        function runMyStudyTimer() {
            if (studyTimerInterval) clearInterval(studyTimerInterval);
            if (liveStatusUpdateInterval) clearInterval(liveStatusUpdateInterval); 

            const sessionStartTotalSeconds = currentTotalStudySeconds;

            studyTimerInterval = setInterval(() => {
                if (!studyStartTime) return;
                const now = new Date();
                const sessionSeconds = Math.floor((now.getTime() - studyStartTime.getTime()) / 1000);
                const newTotalSeconds = sessionStartTotalSeconds + sessionSeconds;

                myStudyTimer.textContent = formatTime(newTotalSeconds);
                if (totalTodayStudyTimeInStudyEl) {
                    totalTodayStudyTimeInStudyEl.textContent = formatTime(newTotalSeconds);
                }
            }, 1000);

            liveStatusUpdateInterval = setInterval(() => {
                if (!studyStartTime) return;
                const now = new Date();
                const sessionSeconds = Math.floor((now.getTime() - studyStartTime.getTime()) / 1000);
                const newTotalSeconds = sessionStartTotalSeconds + sessionSeconds;
                updateLiveStatus(newTotalSeconds); 
            }, 5000);
        }

        async function updateLiveStatus(totalSeconds) {
            if (!userId) return;
            const liveRef = doc(db, "live_status", userId);
            try {
                await setDoc(liveRef, {
                    displayName: currentUser.displayName,
                    subjectName: currentSubject, 
                    status: "studying",
                    subjectColor: subjectColors[currentSubject],
                    liveTotalSeconds: totalSeconds,
                    lastUpdated: Timestamp.now()
                }, { merge: true });
            } catch (e) {
                console.warn("Live status update failed", e);
            }
        }


        function setupStudyListeners() {
            if (friendsListener || totalTodayStudyListener) return; 

            // A. 친구 현황 (live_status 컬렉션)
            const q = query(collection(db, "live_status"));
            friendsListener = onSnapshot(q, (snapshot) => {
                const friends = [];
                const now = Timestamp.now();
                snapshot.forEach(doc => {
                    if (doc.id !== userId) { 
                        const data = doc.data();
                        data.uid = doc.id; 

                        if (data.lastUpdated) {
                            const secondsSinceUpdate = now.seconds - data.lastUpdated.seconds;
                            if (secondsSinceUpdate > 30) {
                                data.status = "offline";
                            }
                        } else {
                            data.status = "offline"; 
                        }
                        friends.push(data);
                    }
                });
                renderFriendsGrid(friends);
            });

            // B. 오늘 총 공부 시간 (리스너는 DB 기준 시간을 표시)
            const { todayString } = getKSTTodayRange();
            const totalStudyRef = doc(db, "users", userId, "total_daily_study", todayString);
            
            totalTodayStudyListener = onSnapshot(totalStudyRef, (doc) => {
                let totalSeconds = 0;
                if (doc.exists()) {
                    totalSeconds = doc.data().totalSeconds || 0;
                }
                currentTotalStudySeconds = totalSeconds;
                totalTodayStudyTimeEl.textContent = formatTime(totalSeconds);
                
                if (!studyTimerInterval && totalTodayStudyTimeInStudyEl) { 
                    totalTodayStudyTimeInStudyEl.textContent = formatTime(totalSeconds);
                }
            });
        }

        function renderFriendsGrid(friends) {
            cleanupFriendsTimers();
            friends.sort((a, b) => (b.liveTotalSeconds || 0) - (a.liveTotalSeconds || 0));
            friendsStudyGrid.innerHTML = ''; 
            
            friends.forEach(friend => {
                const durationSeconds = friend.liveTotalSeconds || 0;
                const isStudying = friend.status === 'studying';
                const subjectColor = friend.subjectColor || '#FFFFFF';
                
                const friendDiv = document.createElement('div');
                friendDiv.className = 'bg-gray-800 p-3 rounded-lg shadow-md text-center border-2';
                friendDiv.style.borderColor = isStudying ? subjectColor : '#4B5563'; 
                
                friendDiv.innerHTML = `
                    <div class="text-sm font-semibold truncate" style="color: ${isStudying ? subjectColor : '#9CA3AF'}">
                        ${isStudying ? (friend.subjectName || '공부 중') : '오프라인'}
                    </div>
                    <div class="text-xs text-gray-400 truncate mb-1">${friend.displayName}</div>
                    <div id="friend-time-${friend.uid}" class="text-lg font-bold">${formatTime(durationSeconds)}</div>
                `;
                friendsStudyGrid.appendChild(friendDiv);

                if (isStudying) {
                    const startSeconds = durationSeconds;
                    const startTime = friend.lastUpdated ? friend.lastUpdated.toDate().getTime() : Date.now(); 
                    
                    friendsTimers[friend.uid] = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        const currentTotal = startSeconds + elapsed;
                        const timerEl = document.getElementById(`friend-time-${friend.uid}`);
                        if (timerEl) {
                            timerEl.textContent = formatTime(currentTotal);
                        } else {
                            clearInterval(friendsTimers[friend.uid]);
                            delete friendsTimers[friend.uid];
                        }
                    }, 1000);
                }
            });
        }
        
        // -----------------------------------------------------------------
        // 8. 통계 모달 (일간)
        // -----------------------------------------------------------------
        
        /**
         * (수정) 일간 통계 로드 (어제와 비교)
         */
        async function loadDailyStats(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const start = new Date(Date.UTC(year, month - 1, day, -9, 0, 0)); 
            const end = new Date(Date.UTC(year, month - 1, day, 14, 59, 59, 999));

            // 1. 총 시간 (선택한 날짜)
            const totalStudyRef = doc(db, "users", userId, "total_daily_study", dateString);
            const totalDoc = await getDoc(totalStudyRef);
            let totalSeconds = 0;
            if (totalDoc.exists()) {
                totalSeconds = totalDoc.data().totalSeconds || 0;
            }
            modalTotalTimeEl.textContent = formatTime(totalSeconds);

            // 2. (수정) 어제 총 시간 및 비교 (3번 요청)
            const todayKSTString = getKSTTodayRange().todayString;
            
            // 오늘 날짜가 아닐 때만 비교
            if (dateString !== todayKSTString) {
                const yesterdayDateString = getYesterdayDateString(dateString);
                const yesterdayTotalRef = doc(db, "users", userId, "total_daily_study", yesterdayDateString);
                const yesterdayDoc = await getDoc(yesterdayTotalRef);
                let yesterdayTotalSeconds = 0;
                if (yesterdayDoc.exists()) yesterdayTotalSeconds = yesterdayDoc.data().totalSeconds || 0;
                
                const diff = totalSeconds - yesterdayTotalSeconds;
                const diffText = formatTime(Math.abs(diff));
                
                if (diff > 0) {
                    modalComparisonTextEl.textContent = `전날보다 ${diffText} 더 공부했어요.`;
                    modalComparisonTextEl.style.color = '#22C55E'; // green-500
                } else if (diff < 0) {
                    modalComparisonTextEl.textContent = `전날보다 ${diffText} 덜 공부했어요.`;
                    modalComparisonTextEl.style.color = '#EF4444'; // red-500
                } else {
                    modalComparisonTextEl.textContent = '전날과 공부 시간이 같아요.';
                    modalComparisonTextEl.style.color = '#9CA3AF'; // gray-400
                }
                modalComparisonTextEl.classList.remove('hidden');
            } else {
                modalComparisonTextEl.classList.add('hidden'); // 오늘 날짜에는 숨김
            }

            // 3. 세션 데이터 (기존과 동일)
            const sessionsQuery = query(
                collection(db, "study_sessions"),
                where("userId", "==", userId),
                where("status", "==", "finished"), 
                where("startTime", ">=", start),
                where("startTime", "<=", end)
            );
            const snapshot = await getDocs(sessionsQuery);
            const sessions = snapshot.docs.map(d => d.data());

            // 4. 데이터 가공 (기존과 동일)
            const subjectData = {}; 
            sessions.forEach(session => {
                const subject = session.subjectName;
                const duration = session.durationSeconds || 0;
                if (!subjectData[subject]) subjectData[subject] = 0;
                subjectData[subject] += duration;
            });
            
            renderPieChart(subjectData);
            renderModalTimeline(sessions);
        }

        function renderPieChart(subjectData) {
            const labels = Object.keys(subjectData);
            const data = Object.values(subjectData);
            const backgroundColors = labels.map(label => subjectColors[label] || '#9CA3AF'); 
            
            const chartData = {
                labels: labels.map((label, i) => `${label} (${formatTime(data[i])})`),
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4
                }]
            };

            if (studyPieChart) studyPieChart.destroy();
            
            studyPieChart = new Chart(pieChartCanvas, {
                type: 'pie', 
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'white', boxWidth: 20 }
                        }
                    }
                }
            });
        }
        
        function renderModalTimeline(sessions) {
            sessions.sort((a, b) => a.startTime.toDate().getTime() - b.startTime.toDate().getTime());
            modalTimelineContainer.innerHTML = ''; 
            if (sessions.length === 0) {
                modalTimelineContainer.innerHTML = '<p class="text-gray-400 text-center">이 날은 공부 기록이 없습니다.</p>';
                return;
            }
            sessions.forEach(session => {
                const start = session.startTime.toDate();
                const end = session.endTime.toDate();
                const duration = session.durationSeconds || 0;
                const startTimeStr = start.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                const endTimeStr = end.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                const timelineItem = document.createElement('div');
                timelineItem.className = 'flex items-center space-x-3 mb-2';
                timelineItem.innerHTML = `
                    <span class="w-5 h-5 rounded-full flex-shrink-0" style="background-color: ${session.subjectColor}"></span>
                    <span class="font-semibold text-white w-24 truncate">${session.subjectName}</span>
                    <span class="text-sm text-gray-300 w-28">${startTimeStr} ~ ${endTimeStr}</span>
                    <span class="text-sm text-gray-400">${formatTime(duration)}</span>
                `;
                modalTimelineContainer.appendChild(timelineItem);
            });
        }

        // -----------------------------------------------------------------
        // 9. 이벤트 리스너 바인딩 (DOM 로드 후)
        // -----------------------------------------------------------------
        
        window.addEventListener('DOMContentLoaded', () => {
            loginBtn.addEventListener('click', signInWithGoogle);
            observeAuthState(); 

            startStudyBtn.addEventListener('click', () => {
                if (currentSubject) startStudy();
            });
            
            timelineScrollContainer.addEventListener('click', (e) => {
                if (e.target.closest('button')) return; 
                const { todayString } = getKSTTodayRange();
                timelineDatePicker.value = todayString;
                loadDailyStats(todayString);
                timelineModal.classList.remove('hidden');
            });

            timelineContainer.addEventListener('scroll', () => {
                timelineHourLabels.scrollTop = timelineContainer.scrollTop;
            });
            timelineHourLabels.addEventListener('wheel', (e) => {
                e.preventDefault();
                timelineContainer.scrollTop += e.deltaY;
            });

            stopStudyBtn.addEventListener('click', stopStudy);

            document.querySelectorAll('.rest-reason-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const reason = btn.dataset.reason;
                    restModal.classList.add('hidden');
                    logRestAndStartStudy(reason);
                });
            });

            closeTimelineModal.addEventListener('click', () => {
                timelineModal.classList.add('hidden');
            });
            
            timelineDatePicker.addEventListener('change', (e) => {
                loadDailyStats(e.target.value);
            });

            setInterval(updateCurrentTimeLine, 60 * 1000);
        });

    </script>
</body>
</html>
